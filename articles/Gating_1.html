<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gating Cells in cytoverse: Part 1 • CytoverseBioc2023</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Gating Cells in cytoverse: Part 1">
<meta property="og:description" content="CytoverseBioc2023">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CytoverseBioc2023</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9006</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Import_fcs.html">Importing and Basics of working with FCS files</a>
    </li>
    <li>
      <a href="../articles/Spillover_v2.html">Spillover, Transformation, and Visualization</a>
    </li>
    <li>
      <a href="../articles/Gating_1.html">Gating Cells in cytoverse: Part 1</a>
    </li>
    <li>
      <a href="../articles/ggcyto_1-5.html">Visualizations (1.5)</a>
    </li>
    <li>
      <a href="../articles/Reporting_1.html">Reporting: Counts, Frequency, etc.</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/OzetteTech/cytoverse-bioc-2023" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Gating Cells in cytoverse: Part 1</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/OzetteTech/cytoverse-bioc-2023/blob/HEAD/vignettes/Gating_1.Rmd" class="external-link"><code>vignettes/Gating_1.Rmd</code></a></small>
      <div class="hidden name"><code>Gating_1.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>The purpose of flow cytometry is to make inferences regarding some
cell type(s) of interest. Often this involves establishing/drawing a
gating heirachy to sequentially filter down to the cell type(s) of
interest. This process is very often done manually, and can be very
labour intensive. Importantly, manual approach implies large variation
when one person does it vs. the next, or even if the same person does it
multiple times. The <code>cytoverse</code> offers a suite of tools to
tackle this problem in a reproducible and programmatic manner.</p>
<div class="section level3">
<h3 id="gatingset-and-gatingheirarchy">GatingSet and GatingHeirarchy<a class="anchor" aria-label="anchor" href="#gatingset-and-gatingheirarchy"></a>
</h3>
<p>In the previous sections, we have seen (and worked with)
<code>flowFrame</code>, <code>flowSet</code>, <code>cytoframe</code>,
and <code>cytoset</code>. These objects hold the underlying FCS data,
allow us to visualize it, manipulate it etc.</p>
<p>In this section we work with <code>GatingSet</code> and
<code>GatingHierarchy</code>. These objects, like the name suggests,
store information regarding various gates and filters that we will
generate. Importantly, we can save the <code>GatingSet</code> which will
completely package the analysis as well as the FCS files in an
opensource format that can be shared, allowing reproducibility.</p>
<p>First, we will go over variety of native methods that exist in the
<code>cytoverse</code> which analysts can utilize to gate their cells of
interest. Next, we will demonstrate how analysts can automate this
process by utilizing a <code>gatingTemplate</code> (a csv file that can
be used to define and build the hierarchy).</p>
</div>
<div class="section level3">
<h3 id="building-the-gating-tree">Building the gating tree<a class="anchor" aria-label="anchor" href="#building-the-gating-tree"></a>
</h3>
<p>Required libraries</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">flowWorkspace</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RGLab/ggcyto/issues" class="external-link">ggcyto</a></span><span class="op">)</span></span>
<span><span class="co"># set ggcyto theme  </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ozettetech.github.io/cytoverse-bioc-2023/">CytoverseBioc2023</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: replacing previous import 'flowViz::contour' by 'graphics::contour'</span></span>
<span><span class="co">## when loading 'flowStats'</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cache_workshop_data.html">cache_workshop_data</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>First we create a <code>GatingSet</code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a cytoset</span></span>
<span><span class="va">fcs_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cache_workshop_data.html">get_workshop_data</a></span><span class="op">(</span><span class="st">"fcs_data/"</span><span class="op">)</span></span>
<span><span class="va">fcs_files_TNK</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fcs_files</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"TNK-CR1"</span>,x <span class="op">=</span> <span class="va">rname</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cs</span> <span class="op">&lt;-</span> <span class="fu">flowWorkspace</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/load_cytoset_from_fcs.html" class="external-link">load_cytoset_from_fcs</a></span><span class="op">(</span>files <span class="op">=</span> <span class="va">fcs_files_TNK</span><span class="op">$</span><span class="va">rpath</span>, <span class="co"># loading a set of FCS files as a cytoset</span></span>
<span>                                           pattern <span class="op">=</span> <span class="st">"TNK-CR1"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add mock metadata</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureNames.html" class="external-link">sampleNames</a></span><span class="op">(</span><span class="va">cs</span><span class="op">)</span>, </span>
<span>                   status <span class="op">=</span> <span class="st">"Healthy"</span>, </span>
<span>                   panel <span class="op">=</span> <span class="st">"T Cell"</span>,</span>
<span>                   mock_treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treated"</span>,<span class="st">"Control"</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">4</span>,prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span>,replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                   row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureNames.html" class="external-link">sampleNames</a></span><span class="op">(</span><span class="va">cs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/phenoData.html" class="external-link">pData</a></span><span class="op">(</span><span class="va">cs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">meta</span></span>
<span></span>
<span><span class="co"># creating a GatingSet</span></span>
<span><span class="va">gs</span> <span class="op">&lt;-</span> <span class="fu">flowWorkspace</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/GatingSet-class.html" class="external-link">GatingSet</a></span><span class="op">(</span><span class="va">cs</span><span class="op">)</span></span>
<span><span class="va">gs</span></span></code></pre></div>
<pre><code><span><span class="co">## A GatingSet with 4 samples</span></span></code></pre>
<p>We have now created a <code>GatingSet</code> called
<strong>gs</strong>. Also note that we have associated some (albeit
mock) metadata to the <code>GatingSet</code>. We are able to leverage
the metadata to help construct gates (if need be).</p>
<p>First, we revisit some of the concepts that we have seen previously:
<strong>compensation</strong> and <strong>transformation</strong>.</p>
<p>We can directly compensate the <code>GatingSet</code> object.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># compensate a GatingSet</span></span>
<span><span class="va">spill</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/keyword-methods.html" class="external-link">keyword</a></span><span class="op">(</span><span class="va">gs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,<span class="st">"$SPILLOVER"</span><span class="op">)</span> <span class="co"># extract spillover matrix stored within the file</span></span>
<span></span>
<span><span class="va">gs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/compensation-class.html" class="external-link">compensate</a></span><span class="op">(</span><span class="va">gs</span>,<span class="va">spill</span><span class="op">)</span> <span class="co"># GatingSet will be compensated and stores the spill matrix as well</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span> <span class="co"># update the gs</span></span>
<span></span>
<span><span class="co"># retrieve compensation information; return NULL is GatingSet was not compensated</span></span>
<span><span class="va">gs_spill</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gh_get_compensations.html" class="external-link">gs_get_compensations</a></span><span class="op">(</span><span class="va">gs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># output is a rich spillover information</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">slot</a></span><span class="op">(</span><span class="va">gs_spill</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,<span class="st">"spillover"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##             B515-A     B610-A     B660-A      B710-A</span></span>
<span><span class="co">## B515-A 1.000000000 0.07573059 0.04266579 0.003687143</span></span>
<span><span class="co">## B610-A 0.009777704 1.00000000 0.78589800 0.074328487</span></span>
<span><span class="co">## B660-A 0.005482375 0.03108691 1.00000000 0.112570733</span></span>
<span><span class="co">## B710-A 0.024698965 0.12699130 0.90643808 1.000000000</span></span></code></pre>
<p>As well we can transform the <code>GatingSet</code>. For convenience,
we are using a previously defined <strong>transformerList</strong>
object. The <strong>transformerList</strong> object was extracted from
the workspace file created by the authors of <a href="https://doi.org/10.1038/s41467-022-34638-2" class="external-link">this</a> study and can
be found <a href="https://flowrepository.org/public_experiment_representations/5932" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># transformation of GatingSet</span></span>
<span><span class="va">t.rds</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="../reference/cache_workshop_data.html">get_workshop_data</a></span><span class="op">(</span><span class="st">"/fj_wsp"</span><span class="op">)</span>, <span class="co"># a previously defined transformation</span></span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"transform"</span>, </span>
<span>                             x <span class="op">=</span> <span class="va">rname</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">rpath</span></span>
<span><span class="va">my_trans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">t.rds</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make into transformerList object</span></span>
<span><span class="va">my_trans_list</span> <span class="op">&lt;-</span> <span class="fu">flowWorkspace</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/transformerList.html" class="external-link">transformerList</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">my_trans</span><span class="op">)</span>,</span>
<span>                                                trans <span class="op">=</span> <span class="va">my_trans</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gs</span> <span class="op">&lt;-</span> <span class="fu">flowWorkspace</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">gs</span>, <span class="va">my_trans_list</span><span class="op">)</span> <span class="co"># transforms underlying data</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adding-gates-and-building-a-hierarchy">Adding gates and building a hierarchy<a class="anchor" aria-label="anchor" href="#adding-gates-and-building-a-hierarchy"></a>
</h3>
<p>Now that we have created a <code>GatingSet</code> we should start
adding various gates that identifies cells of interest. Each sample
within a <code>GatingSet</code> is associated with a
<code>GatingHierarchy</code> that stores information regarding various
gates that we would have created and applied to the samples.</p>
<p>Below, we demonstrate various types of gates that can be applied to
the samples within a <code>GatingSet</code> to build a hierachy.</p>
<p>Note that the gating process is reliant on
<strong>visualization</strong> of the data. As such, we will make ample
use of the <code>ggcyto</code> library, highlighting its usage.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># gates for data cleanup; start by visualizing </span></span>
<span><span class="va">singlet_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gh_pop_get_data.html" class="external-link">gs_pop_get_data</a></span><span class="op">(</span><span class="va">gs</span>,<span class="st">"root"</span><span class="op">)</span>, <span class="co"># gs_pop_get_data(gs, node) extracts the underlying data</span></span>
<span>                        x <span class="op">=</span> <span class="st">"FSC-A"</span>,</span>
<span>                        y <span class="op">=</span> <span class="st">"FSC-H"</span>,</span>
<span>                        bins <span class="op">=</span> <span class="fl">256</span></span>
<span>                        <span class="op">)</span><span class="op">+</span></span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureNames.html" class="external-link">sampleNames</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span><span class="op">)</span> <span class="co"># leverage the metadata that is saved within the GatingSet to facet plots </span></span>
<span></span>
<span><span class="va">singlet_vis</span></span></code></pre></div>
<p><img src="Gating_1_files/figure-html/singlet_gate_viz-1.png" width="700"></p>
<p>Now, we add a gate that is used to filter out
<strong>singlets</strong>. For this, we make use of the
<code>flowStats</code> library from the <code>cytoverse</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate and add a singlet gate</span></span>
<span><span class="va">singlet_gate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/fsApply.html" class="external-link">fsApply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gh_pop_get_data.html" class="external-link">gs_pop_get_data</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> <span class="co"># sample wise calculation using fsApply</span></span>
<span>                <span class="fu">flowStats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flowStats/man/gate_singlet.html" class="external-link">gate_singlet</a></span><span class="op">(</span><span class="va">x</span>, </span>
<span>                                        filterId <span class="op">=</span> <span class="st">"singlet"</span>, <span class="co"># name for the gate</span></span>
<span>                                        wider_gate <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># indicate if the returned gate should be linient</span></span>
<span>                                        prediction_level <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                                        subsample_pct <span class="op">=</span> <span class="fl">0.5</span> <span class="co"># percent of events to sample to calculate the gate</span></span>
<span>                                        <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize</span></span>
<span><span class="va">singlet_vis</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html" class="external-link">geom_gate</a></span><span class="op">(</span><span class="va">singlet_gate</span><span class="op">)</span><span class="op">+</span> <span class="co"># geom_gate takes a single gate or a list of gates as an argument. list should have the same name as sampleNames(gs)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gating_1_files/figure-html/add_singlets_gate-1.png" width="700"></p>
<p>Once visualized, we can add the gates to its respective samples.
<em>Note:</em> Singlets gate was estimated for each sample.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add gate to the GatingSet </span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>, <span class="va">singlet_gate</span>, parent <span class="op">=</span> <span class="st">"root"</span><span class="op">)</span> <span class="co"># add singlet_gate to the root node</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span> <span class="co"># recompute updates the gs</span></span></code></pre></div>
<pre><code><span><span class="co">## done!</span></span></code></pre>
<p>The next few gates are done in a similar manner:</p>
<ul>
<li><p>visualize marker(s)</p></li>
<li><p>use <code>openCyto</code> or <code>flowStats</code> to define
gates</p></li>
<li><p>add to <code>GatingSet</code></p></li>
</ul>
<p>Below we add a variety of additional gates to the samples.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate a live gate </span></span>
<span><span class="co">## Example of a quantile gate</span></span>
<span><span class="va">live_gate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/fsApply.html" class="external-link">fsApply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gh_pop_get_data.html" class="external-link">gs_pop_get_data</a></span><span class="op">(</span><span class="va">gs</span>,<span class="st">"singlet"</span><span class="op">)</span>, <span class="co"># indicating that estimation should be done on filtered data: singlet</span></span>
<span>                     <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>                       <span class="va">gate</span> <span class="op">&lt;-</span> <span class="fu">openCyto</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openCyto/man/gate_quantile.html" class="external-link">gate_quantile</a></span><span class="op">(</span>fr <span class="op">=</span> <span class="va">x</span>, channel <span class="op">=</span> <span class="st">"U450-A"</span>, </span>
<span>                                                      probs <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                                                      filterId <span class="op">=</span> <span class="st">"live"</span></span>
<span>                                                      <span class="op">)</span></span>
<span>                       </span>
<span>                       <span class="co"># keep negative events</span></span>
<span>                       <span class="va">gate</span><span class="op">@</span><span class="va">max</span> <span class="op">&lt;-</span> <span class="va">gate</span><span class="op">@</span><span class="va">min</span></span>
<span>                       <span class="va">gate</span><span class="op">@</span><span class="va">min</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="cn">Inf</span></span>
<span>                       <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">gate</span><span class="op">)</span></span>
<span>                     <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add live gate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>, parent <span class="op">=</span> <span class="st">"singlet"</span>,gate <span class="op">=</span> <span class="va">live_gate</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## done!</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate lymphocyte gate</span></span>
<span><span class="co">## Example of using flowClust</span></span>
<span><span class="va">lymphocyte_gate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/fsApply.html" class="external-link">fsApply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gh_pop_get_data.html" class="external-link">gs_pop_get_data</a></span><span class="op">(</span><span class="va">gs</span>,<span class="st">"live"</span><span class="op">)</span>,</span>
<span>                           <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>                             <span class="fu">openCyto</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openCyto/man/gate_flowclust_2d.html" class="external-link">gate_flowclust_2d</a></span><span class="op">(</span>fr <span class="op">=</span> <span class="va">x</span>,</span>
<span>                                                         xChannel <span class="op">=</span> <span class="st">"FSC-A"</span>,</span>
<span>                                                         yChannel <span class="op">=</span> <span class="st">"SSC-A"</span>,</span>
<span>                                                         filterId <span class="op">=</span> <span class="st">"lymphocytes"</span>,</span>
<span>                                                         K <span class="op">=</span> <span class="fl">1</span>,target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1E5</span>,<span class="fl">0.5E3</span><span class="op">)</span><span class="op">)</span></span>
<span>                           <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## The prior specification has no effect when usePrior=no</span></span></code></pre>
<pre><code><span><span class="co">## Using the serial version of flowClust</span></span></code></pre>
<pre><code><span><span class="co">## The prior specification has no effect when usePrior=no</span></span></code></pre>
<pre><code><span><span class="co">## Using the serial version of flowClust</span></span></code></pre>
<pre><code><span><span class="co">## The prior specification has no effect when usePrior=no</span></span></code></pre>
<pre><code><span><span class="co">## Using the serial version of flowClust</span></span></code></pre>
<pre><code><span><span class="co">## The prior specification has no effect when usePrior=no</span></span></code></pre>
<pre><code><span><span class="co">## Using the serial version of flowClust</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># call it lymphocytes</span></span>
<span><span class="va">lymphocyte_gate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">lymphocyte_gate</span>,</span>
<span>                          <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>                            <span class="va">x</span><span class="op">@</span><span class="va">filterId</span> <span class="op">&lt;-</span> <span class="st">"lymphocytes"</span></span>
<span>                            <span class="va">x</span></span>
<span>                          <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add lymphocyte gate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>, parent <span class="op">=</span> <span class="st">"live"</span>, gate <span class="op">=</span> <span class="va">lymphocyte_gate</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 4</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## done!</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add T cells gate</span></span>
<span><span class="co">## Example of rectangleGate</span></span>
<span><span class="va">cd3_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html" class="external-link">ggcyto</a></span><span class="op">(</span></span>
<span>  <span class="va">gs</span>, subset <span class="op">=</span> <span class="st">"lymphocytes"</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"CD3"</span>, y <span class="op">=</span> <span class="st">"CD56"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_hex.html" class="external-link">geom_hex</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">256</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/axis_x_inverse_trans.html" class="external-link">axis_x_inverse_trans</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/axis_x_inverse_trans.html" class="external-link">axis_y_inverse_trans</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize</span></span>
<span><span class="va">cd3_vis</span></span></code></pre></div>
<p><img src="Gating_1_files/figure-html/additional_gate_examples-1.png" width="700"></p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># using rectangle gate to add T cell gate</span></span>
<span><span class="va">cd3_rectanlge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">140</span>, <span class="fl">205</span>, <span class="fl">0</span>, <span class="fl">200</span><span class="op">)</span>,</span>
<span>                       nrow <span class="op">=</span> <span class="fl">2</span>,ncol <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                       byrow <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                       dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"V510-A"</span>,<span class="st">"U570-A"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># channel names</span></span>
<span><span class="va">cd3_rectangle_gate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/rectangleGate-class.html" class="external-link">rectangleGate</a></span><span class="op">(</span>.gate <span class="op">=</span> <span class="va">cd3_rectanlge</span>,filterId <span class="op">=</span> <span class="st">"CD3+ T cells"</span><span class="op">)</span></span>
<span><span class="va">cd3_vis</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html" class="external-link">geom_gate</a></span><span class="op">(</span><span class="va">cd3_rectangle_gate</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gating_1_files/figure-html/additional_gate_examples-2.png" width="700"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add gate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>, gate <span class="op">=</span> <span class="va">cd3_rectangle_gate</span>, parent <span class="op">=</span> <span class="st">"lymphocytes"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 5</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## done!</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add NKT cell gate</span></span>
<span><span class="co">## Example of polygonGate</span></span>
<span><span class="va">nkt_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html" class="external-link">ggcyto</a></span><span class="op">(</span><span class="va">gs</span>, subset <span class="op">=</span> <span class="st">"CD3+ T cells"</span>,</span>
<span>                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"CD1d"</span>, y <span class="op">=</span> <span class="st">"CD3"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="co"># fuzzy matching of marker names</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_hex.html" class="external-link">geom_hex</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">256</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in getChannelMarker(frm, dim): CD1d is partially matched with</span></span>
<span><span class="co">## R670-ACD1d:PBS57 tet APC</span></span></code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># visualize</span></span>
<span><span class="va">nkt_vis</span></span></code></pre></div>
<p><img src="Gating_1_files/figure-html/additional_gate_examples-3.png" width="700"></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define coordinates</span></span>
<span><span class="va">nkt_poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fl">115</span>,<span class="fl">140</span>,</span>
<span>  <span class="fl">150</span>,<span class="fl">150</span>,</span>
<span>  <span class="fl">150</span>,<span class="fl">180</span>,</span>
<span>  <span class="fl">200</span>,<span class="fl">180</span>,</span>
<span>  <span class="fl">200</span>,<span class="fl">140</span><span class="op">)</span>, <span class="co"># coordinates</span></span>
<span>  ncol <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  byrow <span class="op">=</span> <span class="cn">T</span>,</span>
<span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="co"># rownames </span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R670-A"</span>,<span class="st">"V510-A"</span><span class="op">)</span><span class="op">)</span> <span class="co"># colnames</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert to gate</span></span>
<span><span class="va">nkt_poly_gate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/polygonGate-class.html" class="external-link">polygonGate</a></span><span class="op">(</span><span class="va">nkt_poly</span>,</span>
<span>                             filterId <span class="op">=</span> <span class="st">"NKT cells"</span><span class="op">)</span></span>
<span><span class="co"># visualize</span></span>
<span><span class="va">nkt_vis</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html" class="external-link">geom_gate</a></span><span class="op">(</span><span class="va">nkt_poly_gate</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gating_1_files/figure-html/additional_gate_examples-4.png" width="700"></p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># move gate and make smaller</span></span>
<span><span class="va">nkt_poly_gate</span> <span class="op">&lt;-</span> <span class="fu">flowCore</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/transform_gate.html" class="external-link">transform_gate</a></span><span class="op">(</span><span class="va">nkt_poly_gate</span>,</span>
<span>                                    dx <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                    scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.05</span>,<span class="fl">1.05</span><span class="op">)</span></span>
<span>                                    <span class="op">)</span></span>
<span><span class="va">nkt_vis</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html" class="external-link">geom_gate</a></span><span class="op">(</span><span class="va">nkt_poly_gate</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gating_1_files/figure-html/additional_gate_examples-5.png" width="700"></p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add to gs</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>,<span class="va">nkt_poly_gate</span>, parent <span class="op">=</span> <span class="st">"CD3+ T cells"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 6</span></span></code></pre>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## done!</span></span></code></pre>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add non-NKT cells</span></span>
<span><span class="co">## Example rangeGate</span></span>
<span></span>
<span><span class="co"># make a list of sample specific gates</span></span>
<span><span class="va">non_nkt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">gs</span>,</span>
<span>                  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>                    <span class="va">ff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gh_pop_get_data.html" class="external-link">gh_pop_get_data</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"CD3+ T cells"</span><span class="op">)</span> <span class="co"># extract data at specific node for cleaner calculation</span></span>
<span>                    <span class="fu">flowStats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flowStats/man/rangeGate.html" class="external-link">rangeGate</a></span><span class="op">(</span><span class="va">ff</span>,</span>
<span>                                stain <span class="op">=</span> <span class="st">"R670-A"</span>,</span>
<span>                                filterId <span class="op">=</span> <span class="st">"non-NKT Cells"</span>,</span>
<span>                                positive <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                alpha <span class="op">=</span> <span class="fl">0.1</span></span>
<span>                                <span class="op">)</span></span>
<span>                  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize</span></span>
<span><span class="va">nkt_vis</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html" class="external-link">geom_gate</a></span><span class="op">(</span><span class="va">non_nkt</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gating_1_files/figure-html/additional_gate_examples-6.png" width="700"></p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sample 4002 looks like the gate wasn't set properly. Edit</span></span>
<span><span class="va">non_nkt</span><span class="op">$</span><span class="va">`1615fa39c8b_4002_TNK-CR1.fcs`</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/transform_gate.html" class="external-link">transform_gate</a></span><span class="op">(</span><span class="va">non_nkt</span><span class="op">$</span><span class="va">`1615fa39c8b_4002_TNK-CR1.fcs`</span>,</span>
<span>                                                         dx <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="co"># small shift in x</span></span>
<span><span class="va">nkt_vis</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html" class="external-link">geom_gate</a></span><span class="op">(</span><span class="va">non_nkt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add non_nkt</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>, <span class="va">non_nkt</span>,parent <span class="op">=</span> <span class="st">"CD3+ T cells"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># identify conventional T cells</span></span>
<span><span class="va">t_cell_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html" class="external-link">ggcyto</a></span><span class="op">(</span></span>
<span>  <span class="va">gs</span>, subset <span class="op">=</span> <span class="st">"non-NKT Cells"</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Vg9"</span>, y <span class="op">=</span> <span class="st">"Vd1"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_hex.html" class="external-link">geom_hex</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">256</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example use multiple gating tools and piping</span></span>
<span><span class="co">## Estimate gate by sampling the data within the entire GatingSet</span></span>
<span><span class="va">conv_t_cell_gate</span> <span class="op">&lt;-</span> <span class="va">gs</span> <span class="op">|&gt;</span> </span>
<span>                          <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gh_pop_get_data.html" class="external-link">gs_pop_get_data</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"non-NKT Cells"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/convert.html" class="external-link">cytoset_to_flowSet</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>    <span class="va">sample_n</span> <span class="op">&lt;-</span> <span class="fl">1E3</span></span>
<span>    <span class="va">all_exprs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/fsApply.html" class="external-link">fsApply</a></span><span class="op">(</span><span class="va">x</span>,<span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/exprs.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>,<span class="va">sample_n</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">all_exprs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/flowFrame-class.html" class="external-link">flowFrame</a></span><span class="op">(</span><span class="va">all_exprs</span><span class="op">)</span></span>
<span>    <span class="va">attrs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min"</span>,<span class="st">"max"</span><span class="op">)</span></span>
<span>                               <span class="co"># identify cutpoints</span></span>
<span>                               <span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu">openCyto</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openCyto/man/gate_quantile.html" class="external-link">gate_quantile</a></span><span class="op">(</span><span class="va">all_exprs</span>,</span>
<span>                                                  channel <span class="op">=</span> <span class="st">"B515-A"</span>,</span>
<span>                                                  prob <span class="op">=</span> <span class="fl">0.98</span></span>
<span>                                                  <span class="op">)</span></span>
<span>                               <span class="va">g1_attrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">attrs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">g1</span>,<span class="va">y</span><span class="op">)</span></span>
<span>                               <span class="op">}</span><span class="op">)</span></span>
<span>                               <span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu">openCyto</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openCyto/man/gate_quantile.html" class="external-link">gate_quantile</a></span><span class="op">(</span><span class="va">all_exprs</span>,</span>
<span>                                                  channel <span class="op">=</span> <span class="st">"G575-A"</span>,</span>
<span>                                                  prob <span class="op">=</span> <span class="fl">0.90</span></span>
<span>                                                  <span class="op">)</span></span>
<span>                               <span class="va">g2_attrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">attrs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">g2</span>,<span class="va">y</span><span class="op">)</span></span>
<span>                               <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>                               <span class="co"># get cutpoints</span></span>
<span>                               <span class="va">g1_cutpoint</span> <span class="op">&lt;-</span> <span class="va">g1_attrs</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.infinite</a></span><span class="op">(</span><span class="va">g1_attrs</span><span class="op">)</span><span class="op">]</span></span>
<span>                               <span class="va">g2_cutpoint</span> <span class="op">&lt;-</span> <span class="va">g2_attrs</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.infinite</a></span><span class="op">(</span><span class="va">g2_attrs</span><span class="op">)</span><span class="op">]</span></span>
<span>                               </span>
<span>                               <span class="co"># make rectangleGate</span></span>
<span>                               <span class="va">rg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/rectangleGate-class.html" class="external-link">rectangleGate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"B515-A"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g1_cutpoint</span>,<span class="op">-</span><span class="cn">Inf</span><span class="op">)</span>,</span>
<span>                                        <span class="st">"G575-A"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">g2_cutpoint</span>,<span class="op">-</span><span class="cn">Inf</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                                        filterId <span class="op">=</span> <span class="st">"conv_Tcells"</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span>
<span> </span>
<span><span class="co"># visualize</span></span>
<span><span class="va">t_cell_vis</span><span class="op">+</span><span class="fu">ggcyto</span><span class="fu">:::</span><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html" class="external-link">geom_gate</a></span><span class="op">(</span><span class="va">conv_t_cell_gate</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># adjust gates</span></span>
<span><span class="va">conv_t_cell_gate</span> <span class="op">&lt;-</span> <span class="fu">flowCore</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/transform_gate.html" class="external-link">transform_gate</a></span><span class="op">(</span><span class="va">conv_t_cell_gate</span>,</span>
<span>                                             dx <span class="op">=</span> <span class="fl">11</span>, <span class="co"># change x</span></span>
<span>                                             dy <span class="op">=</span> <span class="fl">11</span> <span class="co"># change y</span></span>
<span>                                             <span class="op">)</span></span>
<span></span>
<span><span class="co"># add  the calculated rectangleGate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>, <span class="va">conv_t_cell_gate</span>,parent <span class="op">=</span> <span class="st">"non-NKT Cells"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># identify MAIT cells</span></span>
<span><span class="va">mait_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html" class="external-link">ggcyto</a></span><span class="op">(</span><span class="va">gs</span>, subset <span class="op">=</span> <span class="st">"conv_Tcells"</span>,</span>
<span>                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x  <span class="op">=</span> <span class="st">"TCR Va7_2"</span>, y <span class="op">=</span> <span class="st">"CD161"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_hex.html" class="external-link">geom_hex</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">256</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># add MAIT cells</span></span>
<span><span class="co">## Example of estimation using collapsed data</span></span>
<span><span class="va">mait_gate_all</span> <span class="op">&lt;-</span> <span class="fu">openCyto</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openCyto/man/gate_flowclust_2d.html" class="external-link">gate_flowclust_2d</a></span><span class="op">(</span>fr <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/flowFrame-class.html" class="external-link">flowFrame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/fsApply.html" class="external-link">fsApply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gh_pop_get_data.html" class="external-link">gs_pop_get_data</a></span><span class="op">(</span><span class="va">gs</span>,<span class="st">"conv_Tcells"</span><span class="op">)</span>,</span>
<span>                                                            <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>                                                              <span class="va">sample_n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, <span class="fl">1E4</span><span class="op">)</span></span>
<span>                                                              <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/exprs.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>,<span class="va">sample_n</span><span class="op">)</span>,<span class="op">]</span></span>
<span>                                                              <span class="op">}</span></span>
<span>                                                            <span class="op">)</span></span>
<span>                                         <span class="op">)</span>,</span>
<span>                                                  xChannel <span class="op">=</span> <span class="st">"V710-A"</span>,</span>
<span>                                                  yChannel <span class="op">=</span> <span class="st">"G660-A"</span>,target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">175</span>,<span class="fl">175</span><span class="op">)</span>,</span>
<span>                                                  K <span class="op">=</span> <span class="fl">14</span>,filterId <span class="op">=</span> <span class="st">"MAIT Cells"</span> <span class="co"># K indicates number of clusters to estimate</span></span>
<span>                                                  </span>
<span>                                         <span class="op">)</span></span>
<span><span class="co"># fix filterId</span></span>
<span><span class="va">mait_gate_all</span><span class="op">@</span><span class="va">filterId</span> <span class="op">&lt;-</span> <span class="st">"MAIT Cells"</span></span>
<span></span>
<span><span class="co"># visualize</span></span>
<span><span class="va">mait_vis</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html" class="external-link">geom_gate</a></span><span class="op">(</span><span class="va">mait_gate_all</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># scale gate</span></span>
<span><span class="va">mait_gate_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/scale_gate.html" class="external-link">scale_gate</a></span><span class="op">(</span><span class="va">mait_gate_all</span>, scale <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add gate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>,gate <span class="op">=</span> <span class="va">mait_gate_all</span>, parent <span class="op">=</span> <span class="st">"conv_Tcells"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add not MAIT gate</span></span>
<span><span class="co">## Example of booleanFilter</span></span>
<span><span class="va">not_mait</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/booleanFilter-class.html" class="external-link">booleanFilter</a></span><span class="op">(</span><span class="va">`!MAIT Cells`</span>, filterId <span class="op">=</span> <span class="st">"not_MAIT"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add boolean gate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>, <span class="va">not_mait</span>, parent <span class="op">=</span> <span class="st">"conv_Tcells"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example of how to use booleanFilter to create a polygon gate</span></span>
<span><span class="va">not_mait_gate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_get_gate.html" class="external-link">gs_pop_get_gate</a></span><span class="op">(</span><span class="va">gs</span>,<span class="st">"MAIT Cells"</span><span class="op">)</span><span class="op">)</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">gate</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_get_gate.html" class="external-link">gh_pop_get_gate</a></span><span class="op">(</span><span class="va">gs</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>,<span class="st">"MAIT Cells"</span><span class="op">)</span></span>
<span>    <span class="co"># enlarge for stringency</span></span>
<span>    <span class="va">gate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/scale_gate.html" class="external-link">scale_gate</a></span><span class="op">(</span><span class="va">gate</span>,<span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">ff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/convert.html" class="external-link">cytoframe_to_flowFrame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gh_pop_get_data.html" class="external-link">gh_pop_get_data</a></span><span class="op">(</span><span class="va">gs</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>,<span class="st">"conv_Tcells"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/filter-methods.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ff</span>,<span class="va">gate</span><span class="op">)</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="va">fl</span><span class="op">@</span><span class="va">subSet</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>    <span class="va">sample_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">idx</span><span class="op">)</span>,<span class="fl">1E5</span><span class="op">)</span></span>
<span>    <span class="va">m.names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">gate</span><span class="op">@</span><span class="va">cov</span><span class="op">)</span></span>
<span>    <span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/exprs.html" class="external-link">exprs</a></span><span class="op">(</span><span class="va">ff</span><span class="op">)</span><span class="op">[</span><span class="va">idx</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">idx</span><span class="op">)</span>,<span class="va">sample_n</span><span class="op">)</span><span class="op">]</span>,<span class="va">m.names</span><span class="op">]</span></span>
<span>    <span class="va">c.hull</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/chull.html" class="external-link">chull</a></span><span class="op">(</span><span class="va">events</span><span class="op">)</span></span>
<span>    <span class="va">polygon_mait</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/polygonGate-class.html" class="external-link">polygonGate</a></span><span class="op">(</span>.gate <span class="op">=</span> <span class="va">events</span><span class="op">[</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">c.hull</span>,<span class="va">c.hull</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,<span class="op">]</span>,</span>
<span>      filterId <span class="op">=</span> <span class="st">"not_MAIT_Polygon"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">not_mait_gate</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureNames.html" class="external-link">sampleNames</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add gate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>,<span class="va">not_mait_gate</span>,parent <span class="op">=</span> <span class="st">"conv_Tcells"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize CD4 vs CD8</span></span>
<span><span class="va">cd4_cd8</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html" class="external-link">ggcyto</a></span><span class="op">(</span><span class="va">gs</span>,subset <span class="op">=</span> <span class="st">"not_MAIT"</span>,</span>
<span>                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"CD4"</span>, y <span class="op">=</span> <span class="st">"CD8"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_hex.html" class="external-link">geom_hex</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">256</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span></span>
<span><span class="va">cd4_cd8</span></span>
<span></span>
<span><span class="co"># add a quad gate</span></span>
<span><span class="va">cd4_cd8_quad_gate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gh_pop_get_data.html" class="external-link">gs_pop_get_data</a></span><span class="op">(</span><span class="va">gs</span>,<span class="st">"not_MAIT"</span><span class="op">)</span>,</span>
<span>                            <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>                              <span class="va">qg</span> <span class="op">&lt;-</span> <span class="fu">openCyto</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openCyto/man/gate_quad_tmix.html" class="external-link">gate_quad_tmix</a></span><span class="op">(</span><span class="va">x</span>, </span>
<span>                                                             channels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"U785-A"</span>,</span>
<span>                                                                          <span class="st">"V570-A"</span><span class="op">)</span>,</span>
<span>                                                             K <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>                              <span class="co"># give readable names</span></span>
<span>                              <span class="va">r.names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"U785-A"</span> <span class="op">=</span> <span class="st">"CD4"</span>, <span class="co"># these are human readable names</span></span>
<span>                                           <span class="st">"V570-A"</span> <span class="op">=</span> <span class="st">"CD8a"</span><span class="op">)</span></span>
<span>                              <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">qg</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> <span class="co"># iterate over each quadrant</span></span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">r.names</span><span class="op">)</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> <span class="co"># iterate over human readable names</span></span>
<span>                                    <span class="va">current.name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">qg</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,<span class="st">"filterId"</span><span class="op">)</span> <span class="co"># keep a record of the current name</span></span>
<span>                                    <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">qg</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,<span class="st">"filterId"</span><span class="op">)</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span> <span class="co"># substitute and apply to qg</span></span>
<span>                                      pattern <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r.names</span><span class="op">)</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>,</span>
<span>                                                           replacement <span class="op">=</span> <span class="va">r.names</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>,</span>
<span>                                                           x <span class="op">=</span> <span class="va">current.name</span><span class="op">)</span></span>
<span>                                  <span class="op">}</span><span class="op">)</span></span>
<span>                                  </span>
<span>                              <span class="op">}</span></span>
<span>                              <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">qg</span><span class="op">)</span> <span class="co"># return modified gate                                     </span></span>
<span>                            <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize</span></span>
<span><span class="va">cd4_cd8</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html" class="external-link">geom_gate</a></span><span class="op">(</span><span class="va">cd4_cd8_quad_gate</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add gate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_add</a></span><span class="op">(</span><span class="va">gs</span>, <span class="va">cd4_cd8_quad_gate</span>,parent <span class="op">=</span> <span class="st">"not_MAIT_Polygon"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># T cell subsets</span></span>
<span><span class="va">cd4_t_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html" class="external-link">ggcyto</a></span><span class="op">(</span><span class="va">gs</span>, subset <span class="op">=</span> <span class="st">"CD4+CD8a-"</span>,</span>
<span>                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"CD45RA"</span>, y <span class="op">=</span> <span class="st">"CCR7"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_hex.html" class="external-link">geom_hex</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">256</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the gating tree</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gs</span>, bool <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize the full gating hierarchy</span></span>
<span><span class="va">final_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">gs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,bins <span class="op">=</span> <span class="fl">256</span>, bool <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html" class="external-link">ggcyto_par_set</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span> <span class="co"># set data range to be determined by data</span></span></code></pre></div>
<p>Best to save the <code>GatingSet</code> now.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># save your work</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/save_gs.html" class="external-link">save_gs</a></span><span class="op">(</span><span class="va">gs</span>, path <span class="op">=</span> <span class="st">"path/to/a/folder"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-opencyto-gatingtemplate">Using openCyto gatingTemplate<a class="anchor" aria-label="anchor" href="#using-opencyto-gatingtemplate"></a>
</h3>
<p>A <code>gatingTemplate</code> is a csv file that describes the gating
sequence and the gating methods. In the <code>gatingTemplate</code> csv
file, we can leverage the various automated gating methods that we have
previously seen, without explicitly requiring to script it in
<strong>R</strong>.</p>
<p>Let’s take a look at an example gatingTemplate</p>
<p>There are 10 columns that are required in a gatingTemplate csv
file:</p>
<ul>
<li>
<strong>alias* </strong>: name (alias) of the gate</li>
<li>
<strong>pop* </strong>: + or -, or a combination such as: –, -+, ++,
+-, or [ADD]</li>
<li>
<strong>parent* </strong>: parent population</li>
<li>
<strong>dims* </strong>: channels or markernames</li>
<li>
<strong>gating_method* </strong>: gating method to be used. example:
<em>mindensity</em>
</li>
<li>
<strong>gating_args</strong>: additional arguments that can be
passed to <strong>gating_methods</strong>
</li>
<li>
<strong>collapseDataForGating</strong>: <strong>logical</strong>
indicating if the data is to be collapsed onto a single
<code>flowFrame</code> before estimation</li>
<li>
<strong>groupBy</strong>: string indicating the grouping variable
(within <code>pData</code> slot of the <code>GatingSet</code>)</li>
<li>
<strong>preprocessing_method</strong>: preprocessing method to be
used</li>
<li>
<strong>preprocessing_args</strong>: additional arguments that can
be passed to <strong>preprocessing_method</strong>
</li>
</ul>
<p><em>Note:</em> * indicates that these fields must be completed. Other
can be left blank.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># required library</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">openCyto</span><span class="op">)</span></span>
<span><span class="co"># read in gatingTemplate</span></span>
<span><span class="va">gt</span> <span class="op">&lt;-</span> <span class="fu">openCyto</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openCyto/man/gatingTemplate-class.html" class="external-link">gatingTemplate</a></span><span class="op">(</span><span class="st">"path/to/csv/file"</span><span class="op">)</span></span></code></pre></div>
<p>Since we have saved our <code>GatingSet</code> let’s first remove all
the nodes including and downstream of <code>singlet</code>.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># clean gs</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/gs_pop_add.html" class="external-link">gs_pop_remove</a></span><span class="op">(</span><span class="va">gs</span>, <span class="st">"singlet"</span><span class="op">)</span> <span class="co"># removes singlet and all children nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add gates defined in gatingTemplate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/openCyto/man/gt_gating.html" class="external-link">gt_gating</a></span><span class="op">(</span><span class="va">gt</span>, <span class="va">gs</span><span class="op">)</span> <span class="co"># simply provide the parsed gatingTemplate and the GatingSet</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/recompute.html" class="external-link">recompute</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gs</span>, bool <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">gs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, bool <span class="op">=</span> <span class="cn">TRUE</span>, bins <span class="op">=</span> <span class="fl">128</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Andrew McDavid, Arpan Neupane.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
